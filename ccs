#!/bin/bash
############################################################
# Claude Code Switch (cc-switch)
############################################################

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

CONFIG_FILE="$HOME/.cc-switch_config"
ACCOUNTS_FILE="$HOME/.cc-switch_accounts"
LEGACY_ACCOUNTS_FILE="$HOME/.ccm_accounts"
KEYCHAIN_SERVICE="${CC_SWITCH_KEYCHAIN_SERVICE:-Claude Code-credentials}"

if [[ -f "$LEGACY_ACCOUNTS_FILE" && ! -f "$ACCOUNTS_FILE" ]]; then
    mv "$LEGACY_ACCOUNTS_FILE" "$ACCOUNTS_FILE"
fi

load_config() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        cat > "$CONFIG_FILE" << 'EOF'
# CC-Switch Configuration File
# OpenRouter API Key
OPENROUTER_API_KEY=
# Optional: Default Model for OpenRouter
OPENROUTER_MODEL=anthropic/claude-3.5-sonnet
EOF
        echo -e "${YELLOW}âš ï¸  Config created: $CONFIG_FILE${NC}" >&2
    fi

    if [[ -f "$CONFIG_FILE" ]]; then
        # We only look for specific keys to keep it safe
        # But we need to support sourcing them into this script context
        # AND potentially exporting them if we are in a switch mode?
        # Actually, we rely on the script to output exports.
        # We just need to read them here to decide what to export.
        while IFS='=' read -r key value || [[ -n "$key" ]]; do
            # Simple parsing
            key=$(echo "$key" | tr -d ' ')
            value=$(echo "$value" | tr -d ' ')
            if [[ "$key" =~ ^# ]]; then continue; fi
            if [[ -z "$key" ]]; then continue; fi
            # Strip 'export'
            key=${key#export}
            
            # Use eval to handle quotes if necessary, simplified here
            # We blindly export to THIS process
            if [[ -n "$key" ]]; then
                export "$key"="$value"
            fi
        done < "$CONFIG_FILE"
    fi
}

mask_token() {
    local t="$1"
    if [[ -z "$t" ]]; then echo "[Not Set]"; return; fi
    echo "[Set] ****${t: -4}"
}

mask_presence() {
    local v_name="$1"
    if [[ -n "${!v_name}" ]]; then echo "[Set]"; else echo "[Not Set]"; fi
}

read_keychain_credentials() {
    local credentials
    local -a services=(
        "$KEYCHAIN_SERVICE"
        "Claude Code - credentials"
        "Claude Code"
        "claude"
        "claude.ai"
    )
    for svc in "${services[@]}"; do
        credentials=$(security find-generic-password -s "$svc" -w 2>/dev/null)
        if [[ $? -eq 0 && -n "$credentials" ]]; then
            KEYCHAIN_SERVICE="$svc"
            echo "$credentials"
            return 0
        fi
    done
    return 1
}

write_keychain_credentials() {
    local credentials="$1"
    local username="$USER"
    security delete-generic-password -s "$KEYCHAIN_SERVICE" >/dev/null 2>&1
    security add-generic-password -a "$username" -s "$KEYCHAIN_SERVICE" -w "$credentials" >/dev/null 2>&1
    local result=$?
    if [[ $result -eq 0 ]]; then
        echo -e "${BLUE}ðŸ”‘ Credentials updated in Keychain${NC}" >&2
    else
        echo -e "${RED}âŒ Failed to update Keychain (Error: $result)${NC}" >&2
    fi
    return $result
}

save_account() {
    local account_name="$1"
    if [[ -z "$account_name" ]]; then
        echo -e "${RED}âŒ Account name required${NC}" >&2
        return 1
    fi
    local credentials=$(read_keychain_credentials)
    if [[ -z "$credentials" ]]; then
        echo -e "${RED}âŒ No credentials found in Keychain. Login first.${NC}" >&2
        return 1
    fi

    if [[ ! -f "$ACCOUNTS_FILE" ]]; then
        echo "{}" > "$ACCOUNTS_FILE"
        chmod 600 "$ACCOUNTS_FILE"
    fi

    local temp_file=$(mktemp)
    local encoded_creds=$(echo "$credentials" | base64)
    
    # Python is reliable for JSON handling usually available on macOS
    # Or just use the simple sed approach as before
    # Let's stick to the sed approach for zero-dependency (except sed)
    if grep -q "\"$account_name\":" "$ACCOUNTS_FILE"; then
         sed -i '' "s/\"$account_name\": *\"[^\"]*\"/\"$account_name\": \"$encoded_creds\"/" "$ACCOUNTS_FILE"
    else
         sed '$d' "$ACCOUNTS_FILE" > "$temp_file"
         if grep -q '"' "$temp_file"; then echo "," >> "$temp_file"; fi
         echo "  \"$account_name\": \"$encoded_creds\"" >> "$temp_file"
         echo "}" >> "$temp_file"
         mv "$temp_file" "$ACCOUNTS_FILE"
    fi
    chmod 600 "$ACCOUNTS_FILE"
    rm -f "$temp_file"
    echo -e "${GREEN}âœ… Account saved: $account_name${NC}" >&2
}

list_accounts() {
    if [[ ! -f "$ACCOUNTS_FILE" ]]; then
        echo -e "${YELLOW}No accounts saved.${NC}" >&2
        return 0
    fi
    echo -e "${BLUE}ðŸ“‹ Saved Profiles:${NC}" >&2
    local current_creds=$(read_keychain_credentials)
    grep --color=never -o '"[^"]*": *"[^"]*"' "$ACCOUNTS_FILE" | while IFS=': ' read -r name encoded; do
        name=$(echo "$name" | tr -d '"')
        encoded=$(echo "$encoded" | tr -d '"')
        local creds=$(echo "$encoded" | base64 -d 2>/dev/null)
        local is_current=""
        if [[ "$creds" == "$current_creds" ]]; then is_current=" ${GREEN}âœ… (Active)${NC}"; fi
        echo -e "   - ${YELLOW}$name${NC}$is_current" >&2
    done
}

delete_account() {
    local account_name="$1"
    if [[ -z "$account_name" ]]; then echo -e "${RED}Name required${NC}" >&2; return 1; fi
    if [[ ! -f "$ACCOUNTS_FILE" ]]; then return 1; fi
    local temp_file=$(mktemp)
    grep -v "\"$account_name\":" "$ACCOUNTS_FILE" > "$temp_file"
    sed -i '' 's/,\s*}/}/g' "$temp_file" 2>/dev/null
    sed -i '' 's/}\s*,/}/g' "$temp_file" 2>/dev/null
    mv "$temp_file" "$ACCOUNTS_FILE"
    chmod 600 "$ACCOUNTS_FILE"
    echo -e "${GREEN}âœ… Deleted: $account_name${NC}" >&2
}

# Actions that produce exports

do_switch_account() {
    local account_name="$1"
    if [[ -z "$account_name" ]]; then echo -e "${RED}Name required${NC}" >&2; return 1; fi
    if [[ ! -f "$ACCOUNTS_FILE" ]]; then echo -e "${RED}No accounts file${NC}" >&2; return 1; fi
    
    local encoded_creds=$(grep -o "\"$account_name\": *\"[^\"]*\"" "$ACCOUNTS_FILE" | cut -d'"' -f4)
    if [[ -z "$encoded_creds" ]]; then echo -e "${RED}Not found: $account_name${NC}" >&2; return 1; fi
    
    local credentials=$(echo "$encoded_creds" | base64 -d)
    if write_keychain_credentials "$credentials"; then
        echo -e "${GREEN}âœ… Switched to profile: $account_name${NC}" >&2
        echo -e "${YELLOW}âš ï¸  Restart Claude Code to apply${NC}" >&2
        
        # Unset provider envs to ensure we use valid Claude Code profile
        echo "unset ANTHROPIC_BASE_URL"
        echo "unset ANTHROPIC_API_URL"
        echo "unset ANTHROPIC_API_KEY"
        echo "unset ANTHROPIC_MODEL"
    else
        return 1
    fi
}

do_switch_provider_openrouter() {
    echo -e "${YELLOW}ðŸ”„ Switching to OpenRouter...${NC}" >&2
    if [[ -n "$OPENROUTER_API_KEY" ]]; then
        echo "export ANTHROPIC_BASE_URL='https://openrouter.ai/api/v1'"
        echo "export ANTHROPIC_API_URL='https://openrouter.ai/api/v1'"
        echo "export ANTHROPIC_API_KEY='$OPENROUTER_API_KEY'"
        local model="${OPENROUTER_MODEL:-anthropic/claude-3.5-sonnet}"
        echo "export ANTHROPIC_MODEL='$model'"
        
        echo -e "${GREEN}âœ… Configured for OpenRouter${NC}" >&2
        echo -e "   Model: $model" >&2
    else
        echo -e "${RED}âŒ OPENROUTER_API_KEY not set${NC}" >&2
        return 1
    fi
}

show_status() {
    echo -e "${BLUE}ðŸ“Š Status:${NC}" >&2
    if [[ -n "$ANTHROPIC_BASE_URL" ]]; then
        echo "   Mode: Service Provider" >&2
        echo "   URL: $ANTHROPIC_BASE_URL" >&2
        echo "   Model: ${ANTHROPIC_MODEL}" >&2
    else
        echo "   Mode: Claude Pro Profile" >&2
        # Check active
        local creds=$(read_keychain_credentials)
        if [[ -n "$creds" ]]; then
            local sub=$(echo "$creds" | grep -o '"subscriptionType":"[^"]*"' | cut -d'"' -f4)
            echo "   Subscription: ${sub:-Unknown}" >&2
        else
            echo "   Status: No credentials" >&2
        fi
    fi
    echo "" >&2
    echo "   OPENROUTER_API_KEY: $(mask_presence OPENROUTER_API_KEY)" >&2
}

usage() {
    echo "Usage: ccs [list|save|use|del] ..." >&2
    echo "       ccs openrouter" >&2
    echo "       ccs status" >&2
}

load_config

case "$1" in
    list) list_accounts ;;
    save) save_account "$2" ;;
    use|switch)
        if [[ "$2" == "openrouter" ]]; then
            do_switch_provider_openrouter
        else
            do_switch_account "$2"
        fi
        ;;
    del|delete) delete_account "$2" ;;
    openrouter) do_switch_provider_openrouter ;;
    status) show_status ;;
    *) usage ;;
esac
