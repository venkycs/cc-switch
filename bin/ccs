#!/bin/bash
############################################################
# Claude Code Switch (cc-switch)
############################################################

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

CONFIG_FILE="$HOME/.cc-switch_config"
ACCOUNTS_FILE="$HOME/.cc-switch_accounts"
LEGACY_ACCOUNTS_FILE="$HOME/.ccm_accounts"
KEYCHAIN_SERVICE="${CC_SWITCH_KEYCHAIN_SERVICE:-Claude Code-credentials}"
OS_TYPE=$(uname)
VERSION="1.0.0"
GITHUB_REPO="venkycs/cc-switch"
GITHUB_RAW="https://raw.githubusercontent.com/${GITHUB_REPO}/main"

# Cross-platform helpers
sed_i() {
    if [[ "$OS_TYPE" == "Darwin" ]]; then
        sed -i '' "$@"
    else
        sed -i "$@"
    fi
}

base64_decode() {
    if [[ "$OS_TYPE" == "Darwin" ]]; then
        base64 -D 2>/dev/null || base64 -d 2>/dev/null
    else
        base64 -d 2>/dev/null || base64 --decode 2>/dev/null
    fi
}

if [[ -f "$LEGACY_ACCOUNTS_FILE" && ! -f "$ACCOUNTS_FILE" ]]; then
    mv "$LEGACY_ACCOUNTS_FILE" "$ACCOUNTS_FILE"
fi

load_config() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        cat > "$CONFIG_FILE" << 'EOF'
# CC-Switch Configuration File
# OpenRouter API Key
OPENROUTER_API_KEY=
# Optional: Default Model for OpenRouter
OPENROUTER_MODEL=anthropic/claude-3.5-sonnet
EOF
        echo -e "${YELLOW}âš ï¸  Config created: $CONFIG_FILE${NC}" >&2
    fi

    if [[ -f "$CONFIG_FILE" ]]; then
        # We only look for specific keys to keep it safe
        # But we need to support sourcing them into this script context
        # AND potentially exporting them if we are in a switch mode?
        # Actually, we rely on the script to output exports.
        # We just need to read them here to decide what to export.
        while IFS='=' read -r key value || [[ -n "$key" ]]; do
            # Simple parsing
            key=$(echo "$key" | tr -d ' ')
            value=$(echo "$value" | tr -d ' ')
            if [[ "$key" =~ ^# ]]; then continue; fi
            if [[ -z "$key" ]]; then continue; fi
            # Strip 'export'
            key=${key#export}
            
            # Use eval to handle quotes if necessary, simplified here
            # We blindly export to THIS process
            if [[ -n "$key" ]]; then
                export "$key"="$value"
            fi
        done < "$CONFIG_FILE"
    fi
}

mask_token() {
    local t="$1"
    if [[ -z "$t" ]]; then echo "[Not Set]"; return; fi
    echo "[Set] ****${t: -4}"
}

mask_presence() {
    local v_name="$1"
    if [[ -n "${!v_name}" ]]; then echo "[Set]"; else echo "[Not Set]"; fi
}

read_keychain_credentials() {
    # Check for Mac Keychain
    if command -v security >/dev/null 2>&1; then
        local credentials
        local -a services=(
            "$KEYCHAIN_SERVICE"
            "Claude Code - credentials"
            "Claude Code"
            "claude"
            "claude.ai"
        )
        for svc in "${services[@]}"; do
            credentials=$(security find-generic-password -s "$svc" -w 2>/dev/null)
            if [[ $? -eq 0 && -n "$credentials" ]]; then
                KEYCHAIN_SERVICE="$svc"
                echo "$credentials"
                return 0
            fi
        done
        return 1
    else
        # Linux / Fallback: Read from a secure local file acting as a keychain
        # This is a basic implementation for Linux compatibility
        local linux_keychain="$HOME/.cc-switch_linux_keychain"
        if [[ -f "$linux_keychain" ]]; then
             cat "$linux_keychain"
             return 0
        fi
        return 1
    fi
}

write_keychain_credentials() {
    local credentials="$1"
    local username="$USER"
    
    if command -v security >/dev/null 2>&1; then
        security delete-generic-password -s "$KEYCHAIN_SERVICE" >/dev/null 2>&1
        security add-generic-password -a "$username" -s "$KEYCHAIN_SERVICE" -w "$credentials" >/dev/null 2>&1
        local result=$?
        if [[ $result -eq 0 ]]; then
            echo -e "${BLUE}ðŸ”‘ Credentials updated in Mac Keychain${NC}" >&2
        else
            echo -e "${RED}âŒ Failed to update Keychain (Error: $result)${NC}" >&2
        fi
        return $result
    else
        # Linux / Fallback
        local linux_keychain="$HOME/.cc-switch_linux_keychain"
        echo "$credentials" > "$linux_keychain"
        chmod 600 "$linux_keychain"
        echo -e "${BLUE}ðŸ”‘ Credentials updated in local file (${linux_keychain})${NC}" >&2
        return 0
    fi
}

save_account() {
    local account_name="$1"
    if [[ -z "$account_name" ]]; then
        echo -e "${RED}âŒ Account name required${NC}" >&2
        return 1
    fi
    local credentials=$(read_keychain_credentials)
    if [[ -z "$credentials" ]]; then
        echo -e "${RED}âŒ No credentials found in Keychain. Login first.${NC}" >&2
        return 1
    fi

    if [[ ! -f "$ACCOUNTS_FILE" ]]; then
        echo "{}" > "$ACCOUNTS_FILE"
        chmod 600 "$ACCOUNTS_FILE"
    fi

    local temp_file=$(mktemp)
    local encoded_creds=$(echo "$credentials" | base64)
    
    # Python is reliable for JSON handling usually available on macOS
    # Or just use the simple sed approach as before
    # Let's stick to the sed approach for zero-dependency (except sed)
    if grep -q "\"$account_name\":" "$ACCOUNTS_FILE"; then
         sed_i "s/\"$account_name\": *\"[^\"]*\"/\"$account_name\": \"$encoded_creds\"/" "$ACCOUNTS_FILE"
    else
         sed '$d' "$ACCOUNTS_FILE" > "$temp_file"
         if grep -q '"' "$temp_file"; then echo "," >> "$temp_file"; fi
         echo "  \"$account_name\": \"$encoded_creds\"" >> "$temp_file"
         echo "}" >> "$temp_file"
         mv "$temp_file" "$ACCOUNTS_FILE"
    fi
    chmod 600 "$ACCOUNTS_FILE"
    rm -f "$temp_file"
    echo -e "${GREEN}âœ… Account saved: $account_name${NC}" >&2
    echo -e "${BLUE}â„¹ï¸  Saved to: $ACCOUNTS_FILE${NC}" >&2
}

list_accounts() {
    if [[ ! -f "$ACCOUNTS_FILE" ]]; then
        echo -e "${YELLOW}No accounts saved.${NC}" >&2
        return 0
    fi
    echo -e "${BLUE}ðŸ“‹ Saved Profiles:${NC}" >&2
    local current_creds=$(read_keychain_credentials)
    grep --color=never -o '"[^"]*": *"[^"]*"' "$ACCOUNTS_FILE" | while IFS=': ' read -r name encoded; do
        name=$(echo "$name" | tr -d '"')
        encoded=$(echo "$encoded" | tr -d '"')
        local creds=$(echo "$encoded" | base64_decode)
        local is_current=""
        if [[ "$creds" == "$current_creds" ]]; then is_current=" ${GREEN}âœ… (Active)${NC}"; fi
        echo -e "   - ${YELLOW}$name${NC}$is_current" >&2
    done
}

delete_account() {
    local account_name="$1"
    if [[ -z "$account_name" ]]; then echo -e "${RED}Name required${NC}" >&2; return 1; fi
    if [[ ! -f "$ACCOUNTS_FILE" ]]; then return 1; fi
    local temp_file=$(mktemp)
    grep -v "\"$account_name\":" "$ACCOUNTS_FILE" > "$temp_file"
    sed_i 's/,\s*}/}/g' "$temp_file" 2>/dev/null
    sed_i 's/}\s*,/}/g' "$temp_file" 2>/dev/null
    mv "$temp_file" "$ACCOUNTS_FILE"
    chmod 600 "$ACCOUNTS_FILE"
    echo -e "${GREEN}âœ… Deleted: $account_name${NC}" >&2
    echo -e "${BLUE}â„¹ï¸  Updated file: $ACCOUNTS_FILE${NC}" >&2
}

set_openrouter_key() {
    local key="$1"
    if [[ -z "$key" ]]; then
        echo -e "${RED}API Key required${NC}" >&2
        return 1
    fi
    
    # Create config if missing
    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo "# CC-Switch Configuration File" > "$CONFIG_FILE"
        chmod 600 "$CONFIG_FILE"
    fi
    
    # Update or append key using standard tools (grep/sed or cat)
    if grep -q "OPENROUTER_API_KEY=" "$CONFIG_FILE"; then
        # Use a temporary file to handle the replacement safely
        local temp_file=$(mktemp)
        # Escape special chars in key if any (though typically basic chars)
        # We'll assume standard API key format.
        # But to be safe with sed, we should use a different delimiter or escape slashes.
        # However, simplistic approach: grep -v then append
        grep -v "OPENROUTER_API_KEY=" "$CONFIG_FILE" > "$temp_file"
        echo "OPENROUTER_API_KEY=$key" >> "$temp_file"
        mv "$temp_file" "$CONFIG_FILE"
    else
        echo "OPENROUTER_API_KEY=$key" >> "$CONFIG_FILE"
    fi
    chmod 600 "$CONFIG_FILE"
    echo -e "${GREEN}âœ… OpenRouter API Key set.${NC}" >&2
    echo -e "${BLUE}â„¹ï¸  Config file updated: $CONFIG_FILE${NC}" >&2
}

set_openrouter_model() {
    local model="$1"
    if [[ -z "$model" ]]; then
        echo -e "${RED}Model name required${NC}" >&2
        return 1
    fi
    
    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo "# CC-Switch Configuration File" > "$CONFIG_FILE"
        chmod 600 "$CONFIG_FILE"
    fi
    
    if grep -q "OPENROUTER_MODEL=" "$CONFIG_FILE"; then
        local temp_file=$(mktemp)
        grep -v "OPENROUTER_MODEL=" "$CONFIG_FILE" > "$temp_file"
        echo "OPENROUTER_MODEL=$model" >> "$temp_file"
        mv "$temp_file" "$CONFIG_FILE"
    else
        echo "OPENROUTER_MODEL=$model" >> "$CONFIG_FILE"
    fi
    chmod 600 "$CONFIG_FILE"
    echo -e "${GREEN}âœ… OpenRouter Model set to: $model${NC}" >&2
    echo -e "${BLUE}â„¹ï¸  Config file updated: $CONFIG_FILE${NC}" >&2
}

login_and_save() {
    local account_name="$1"
    if [[ -z "$account_name" ]]; then
        echo -e "${RED}Profile name required${NC}" >&2
        echo -e "${YELLOW}Usage: ccs login <profile_name>${NC}" >&2
        return 1
    fi
    
    # Ensure 'claude' CLI is available
    if ! command -v claude >/dev/null 2>&1; then
        echo -e "${RED}âŒ 'claude' command not found.${NC}" >&2
        echo -e "${YELLOW}Please install it first: npm install -g @anthropic-ai/claude-code${NC}" >&2
        return 1
    fi
    
    echo -e "${BLUE}ðŸš€ Launching Claude Code for login...${NC}" >&2
    echo -e "${YELLOW}1. Please complete the login process in the browser.${NC}" >&2
    echo -e "${YELLOW}2. Once logged in, exit Claude Code (type '/exit' or Ctrl+C).${NC}" >&2
    echo -e "${YELLOW}3. We will automatically save your profile as '${account_name}'.${NC}" >&2
    echo "" >&2
    
    # Unset any provider environment variables to ensure official login
    unset ANTHROPIC_BASE_URL
    unset ANTHROPIC_API_URL
    unset ANTHROPIC_API_KEY
    unset ANTHROPIC_MODEL
    
    # Run claude
    # We use 'claude' directly with skip permissions as requested
    claude --dangerously-skip-permissions
    
    # After exit, try to save
    echo "" >&2
    echo -e "${BLUE}ðŸ’¾ Saving profile '${account_name}'...${NC}" >&2
    save_account "$account_name"
}

# Actions that produce exports

do_switch_account() {
    local account_name="$1"
    if [[ -z "$account_name" ]]; then echo -e "${RED}Name required${NC}" >&2; return 1; fi
    if [[ ! -f "$ACCOUNTS_FILE" ]]; then echo -e "${RED}No accounts file${NC}" >&2; return 1; fi
    
    local encoded_creds=$(grep -o "\"$account_name\": *\"[^\"]*\"" "$ACCOUNTS_FILE" | cut -d'"' -f4)
    if [[ -z "$encoded_creds" ]]; then echo -e "${RED}Not found: $account_name${NC}" >&2; return 1; fi
    
    local credentials=$(echo "$encoded_creds" | base64_decode)
    if write_keychain_credentials "$credentials"; then
        echo -e "${GREEN}âœ… Switched to profile: $account_name${NC}" >&2
        echo -e "${BLUE}â„¹ï¸  Updated Keychain service: ${KEYCHAIN_SERVICE}${NC}" >&2
        echo -e "${YELLOW}âš ï¸  Restart Claude Code to apply${NC}" >&2
        echo -e "${BLUE}â„¹ï¸  Clearing provider environment variables...${NC}" >&2
        
        # Unset provider envs to ensure we use valid Claude Code profile
        echo "unset ANTHROPIC_BASE_URL"
        echo "unset ANTHROPIC_API_URL"
        echo "unset ANTHROPIC_API_KEY"
        echo "unset ANTHROPIC_MODEL"
    else
        return 1
    fi
}

do_switch_provider_openrouter() {
    echo -e "${YELLOW}ðŸ”„ Switching to OpenRouter...${NC}" >&2
    if [[ -n "$OPENROUTER_API_KEY" ]]; then
        echo "export ANTHROPIC_BASE_URL='https://openrouter.ai/api/v1'"
        echo "export ANTHROPIC_API_URL='https://openrouter.ai/api/v1'"
        echo "export ANTHROPIC_API_KEY='$OPENROUTER_API_KEY'"
        local model="${OPENROUTER_MODEL:-anthropic/claude-3.5-sonnet}"
        echo "export ANTHROPIC_MODEL='$model'"
        
        echo -e "${GREEN}âœ… Configured for OpenRouter${NC}" >&2
        echo -e "${BLUE}â„¹ï¸  Setting ANTHROPIC_BASE_URL to https://openrouter.ai/api/v1${NC}" >&2
        echo -e "   Model: $model" >&2
    else
        echo -e "${RED}âŒ OPENROUTER_API_KEY not set${NC}" >&2
        return 1
    fi
}

show_status() {
    echo -e "${BLUE}ðŸ“Š Status:${NC}" >&2
    if [[ -n "$ANTHROPIC_BASE_URL" ]]; then
        echo "   Mode: Service Provider" >&2
        echo "   URL: $ANTHROPIC_BASE_URL" >&2
        echo "   Model: ${ANTHROPIC_MODEL}" >&2
    else
        echo "   Mode: Claude Pro Profile" >&2
        # Check active
        local creds=$(read_keychain_credentials)
        if [[ -n "$creds" ]]; then
            local sub=$(echo "$creds" | grep -o '"subscriptionType":"[^"]*"' | cut -d'"' -f4)
            echo "   Subscription: ${sub:-Unknown}" >&2
        else
            echo "   Status: No credentials" >&2
        fi
    fi
    echo "" >&2
    echo "   OPENROUTER_API_KEY: $(mask_presence OPENROUTER_API_KEY)" >&2
    echo "" >&2
    echo -e "${BLUE}â„¹ï¸  Config File used: $CONFIG_FILE${NC}" >&2
    echo -e "${BLUE}â„¹ï¸  Accounts File used: $ACCOUNTS_FILE${NC}" >&2
    echo -e "${BLUE}â„¹ï¸  Version: $VERSION${NC}" >&2
}

update_tool() {
    echo -e "${BLUE}â¬‡ï¸  Checking for updates...${NC}" >&2
    local remote_version
    # Extract version from remote script (looking for VERSION="x.x.x")
    remote_version=$(curl -fsSL "${GITHUB_RAW}/bin/ccs" | grep '^VERSION=' | head -1 | cut -d'"' -f2)
    
    if [[ -z "$remote_version" ]]; then
        echo -e "${RED}âŒ Failed to check for updates (network or repo error)${NC}" >&2
        return 1
    fi
    
    if [[ "$VERSION" == "$remote_version" ]]; then
        echo -e "${GREEN}âœ… You are on the latest version ($VERSION)${NC}" >&2
        return 0
    fi
    
    echo -e "${YELLOW}ðŸš€ New version available: $remote_version (Current: $VERSION)${NC}" >&2
    echo -e "${BLUE}â¬‡ï¸  Updating...${NC}" >&2
    
    local tmp_script=$(mktemp)
    if curl -fsSL "${GITHUB_RAW}/bin/ccs" -o "$tmp_script"; then
        chmod +x "$tmp_script"
        # Verify it runs (simple check)
        if ! "$tmp_script" status >/dev/null 2>&1; then
             # Status might fail if not configured, try help or usage by passing invalid arg? 
             # Or just trust curl if exit code 0.
             true
        fi
        
        # Self overwrite
        # We need to know where we are.
        # If installed via install.sh, we are likely at ~/.local/share/cc-switch/ccs
        # But $0 might be the function.
        # We know the install path is fixed in recent architectures.
        local install_path="${XDG_DATA_HOME:-$HOME/.local/share}/cc-switch/ccs"
        
        # Create directory just in case
        mkdir -p "$(dirname "$install_path")"
        
        mv "$tmp_script" "$install_path"
        chmod +x "$install_path"
        
        echo -e "${GREEN}âœ… Updated to version $remote_version${NC}" >&2
        echo -e "${BLUE}â„¹ï¸  Please reload your shell or run: source ~/.zshrc (or ~/.bashrc)${NC}" >&2
    else
        echo -e "${RED}âŒ Update failed during download${NC}" >&2
        rm -f "$tmp_script"
        return 1
    fi
}

usage() {
    echo "Usage: ccs [list|save|use|del] ..." >&2
    echo "       ccs login <name>     # Login and save profile" >&2
    echo "       ccs key <key>        # Set OpenRouter API Key (alias: set-key)" >&2
    echo "       ccs model <name>     # Set OpenRouter Model (alias: set-model)" >&2
    echo "       ccs or               # Switch to OpenRouter (alias: openrouter)" >&2
    echo "       ccs update           # Update to latest version" >&2
    echo "       ccs run [args]       # Run Claude Code with --dangerously-skip-permissions" >&2
    echo "       ccs status" >&2
}

load_config

case "$1" in
    list) list_accounts ;;
    save) save_account "$2" ;;
    login) login_and_save "$2" ;;
    key|set-key) set_openrouter_key "$2" ;;
    model|set-model) set_openrouter_model "$2" ;;
    use|switch)
        if [[ "$2" == "openrouter" ]]; then
            do_switch_provider_openrouter
        else
            do_switch_account "$2"
        fi
        ;;
    del|delete) delete_account "$2" ;;
    or|openrouter) do_switch_provider_openrouter ;;
    run) shift; claude --dangerously-skip-permissions "$@" ;;
    update) update_tool ;;
    status) show_status ;;
    help|--help|-h) usage ;;
    *) usage ;;
esac
